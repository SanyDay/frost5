<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Frostpunk 2 - Аудиоплеер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a192f, #122c4d, #0a192f);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            color: #e0f7ff;
            position: relative;
        }

        /* Снежный фон */
        .snow-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .frostpunk-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            min-height: 600px;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(0, 100, 200, 0.5);
            background: rgba(10, 25, 47, 0.85);
            border: 2px solid rgba(100, 150, 200, 0.2);
            z-index: 10;
        }

        .city-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 150, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(0, 100, 200, 0.1) 0%, transparent 40%);
            z-index: 1;
        }

        .frost-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0, 30, 60, 0.9) 0%, rgba(0, 20, 40, 0.95) 100%);
            z-index: 2;
        }

        .content {
            position: relative;
            z-index: 3;
            padding: 30px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
        }

        .title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            text-shadow: 0 0 15px rgba(0, 200, 255, 0.7);
            letter-spacing: 4px;
            background: linear-gradient(to right, #8e9eab, #eef2f3);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            opacity: 0.9;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 200, 255, 0.5);
            color: #c0e0ff;
        }

        .player-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            gap: 20px;
            margin-bottom: 20px;
        }

        .visualizer-container {
            width: 95%;
            height: 180px;
            background: rgba(0, 20, 40, 0.4);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 
                inset 0 0 15px rgba(0, 0, 0, 0.5),
                0 0 15px rgba(0, 150, 255, 0.3);
            border: 1px solid rgba(0, 100, 200, 0.3);
            position: relative;
            overflow: hidden;
        }

        .visualizer {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            height: 100%;
            gap: 6px;
        }

        .bar {
            width: 14px;
            background: linear-gradient(to top, #00b4ff, #0077ff);
            border-radius: 7px 7px 0 0;
            transition: height 0.15s ease-out;
            position: relative;
            box-shadow: 0 0 8px rgba(0, 150, 255, 0.5);
            max-height: 100%;
        }

        .bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.7), transparent);
            border-radius: 7px 7px 0 0;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 95%;
            gap: 15px;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 20, 40, 0.6);
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 100, 200, 0.3);
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #00b4ff, #0077ff);
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(0, 150, 255, 0.5);
        }

        .buttons {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }

        .btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #1a2a6c, #0f1a40);
            border: 2px solid rgba(0, 150, 255, 0.5);
            color: #e0f7ff;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 
                0 0 15px rgba(0, 100, 200, 0.5),
                inset 0 0 10px rgba(0, 50, 100, 0.5);
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.1);
            box-shadow: 
                0 0 20px rgba(0, 150, 255, 0.7),
                inset 0 0 10px rgba(0, 100, 200, 0.7);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: -5px;
            font-size: 14px;
            opacity: 0.8;
            font-family: 'Orbitron', sans-serif;
        }

        .frost-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
        }

        .snowflake {
            position: absolute;
            top: -20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            animation: fall linear forwards;
            text-shadow: 0 0 5px rgba(200, 230, 255, 0.8);
            opacity: 0;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) translateX(var(--wind)) rotate(360deg);
                opacity: 1;
            }
        }

        .snowflake:nth-child(5n) { animation-duration: 8s; }
        .snowflake:nth-child(5n+1) { animation-duration: 10s; }
        .snowflake:nth-child(5n+2) { animation-duration: 12s; }
        .snowflake:nth-child(5n+3) { animation-duration: 14s; }
        .snowflake:nth-child(5n+4) { animation-duration: 16s; }

        .steam {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(0, 40, 85, 0.9), transparent);
            opacity: 0.7;
        }

        .steam-effect {
            position: absolute;
            bottom: 0;
            width: 100px;
            height: 100px;
            background: rgba(200, 230, 255, 0.1);
            border-radius: 50%;
            filter: blur(20px);
            animation: steam 6s infinite ease-in-out;
        }

        @keyframes steam {
            0%, 100% { 
                transform: translateY(0) scale(0.8);
                opacity: 0.3;
            }
            50% { 
                transform: translateY(-50px) scale(1.2);
                opacity: 0.6;
            }
        }

        .gear {
            position: absolute;
            font-size: 40px;
            color: rgba(0, 150, 255, 0.2);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            to {
                transform: rotate(360deg);
            }
        }

        .message-box {
            background: rgba(0, 15, 30, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 8px;
            padding: 25px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 50, 100, 0.4);
            font-family: 'Montserrat', sans-serif;
            line-height: 1.8;
        }

        .message-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(0, 200, 255, 0.7);
            color: #c0e0ff;
        }

        .message-content {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #e0f7ff;
            text-align: center;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .typing-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            text-align: center;
            color: #00b4ff;
            text-shadow: 0 0 10px rgba(0, 200, 255, 0.7);
            border-right: 2px solid #00b4ff;
            padding-right: 5px;
            white-space: pre-wrap;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px;
        }

        /* Стили для поля ввода и кнопки */
        .answer-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .answer-input {
            padding: 12px 20px;
            border: 2px solid rgba(0, 150, 255, 0.5);
            border-radius: 30px;
            background: rgba(0, 20, 40, 0.5);
            color: #e0f7ff;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 100, 200, 0.3);
            outline: none;
            transition: all 0.3s;
        }

        .answer-input:focus {
            border-color: #00b4ff;
            box-shadow: 0 0 15px rgba(0, 200, 255, 0.7);
        }

        .submit-btn {
            padding: 12px 30px;
            background: linear-gradient(to right, #0077ff, #00b4ff);
            border: none;
            border-radius: 30px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.5);
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(0, 200, 255, 0.8);
        }

        /* Стили для всплывающих сообщений */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s forwards;
            opacity: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        @keyframes slideIn {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }

        .success-notification {
            background: linear-gradient(to right, #00c853, #009624);
            color: white;
        }

        .error-notification {
            background: linear-gradient(to right, #ff5252, #b71c1c);
            color: white;
            animation: slideIn 0.5s forwards, fadeOut 0.5s forwards 2.5s;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
        }

        .close-btn:hover {
            transform: scale(1.2);
        }

        .info-panel {
            display: flex;
            justify-content: space-between;
            width: 95%;
            margin-top: 10px;
            padding: 15px;
            background: rgba(0, 15, 30, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(0, 100, 200, 0.3);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            font-family: 'Montserrat', sans-serif;
        }

        .info-item {
            text-align: center;
            flex: 1;
        }

        .info-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #00b4ff;
            font-family: 'Orbitron', sans-serif;
        }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .frostpunk-container {
                min-height: auto;
                width: 95%;
                margin: 10px auto;
                border-radius: 8px;
                box-shadow: 0 0 20px rgba(0, 100, 200, 0.3);
            }
            
            .content {
                padding: 15px;
            }
            
            .title {
                font-size: 1.8rem;
                letter-spacing: 2px;
            }
            
            .subtitle {
                font-size: 0.9rem;
                letter-spacing: 1px;
            }
            
            .visualizer-container {
                height: 100px;
                padding: 10px;
            }
            
            .bar {
                width: 6px;
            }
            
            .buttons {
                gap: 15px;
            }
            
            .btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .message-box {
                padding: 15px;
            }
            
            .message-title {
                font-size: 1.2rem;
            }
            
            .typing-text {
                font-size: 0.9rem;
                min-height: 60px;
                padding: 10px;
            }
            
            .info-panel {
                flex-direction: column;
                gap: 12px;
                padding: 10px;
            }
            
            .notification {
                width: 90%;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .answer-form {
                gap: 10px;
                margin-top: 10px;
            }
            
            .answer-input {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .submit-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            body {
                overflow: auto;
                min-height: 100vh;
                padding: 0;
            }
            
            .frostpunk-container {
                width: 100%;
                height: auto;
                min-height: 100vh;
                border-radius: 0;
                margin: 0;
                box-shadow: none;
                overflow-y: auto;
            }
            
            .content {
                padding: 10px;
                height: auto;
                min-height: 100vh;
            }
            
            .header {
                margin-bottom: 10px;
                padding-bottom: 10px;
            }
            
            .title {
                font-size: 1.4rem;
                letter-spacing: 1px;
            }
            
            .subtitle {
                font-size: 0.8rem;
            }
            
            .player-container {
                gap: 12px;
                margin-bottom: 12px;
            }
            
            .visualizer-container {
                height: 70px;
                padding: 8px;
            }
            
            .bar {
                width: 4px;
                border-radius: 3px 3px 0 0;
            }
            
            .controls {
                gap: 8px;
                width: 100%;
            }
            
            .progress-container {
                height: 6px;
            }
            
            .buttons {
                gap: 10px;
            }
            
            .btn {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            
            .time-info {
                font-size: 0.8rem;
            }
            
            .message-box {
                padding: 10px;
                margin: 5px 0;
            }
            
            .message-title {
                font-size: 1rem;
                margin-bottom: 8px;
            }
            
            .typing-text {
                font-size: 0.75rem;
                min-height: 50px;
                padding: 8px;
            }
            
            .info-panel {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 5px;
                padding: 8px;
            }
            
            .info-item {
                flex: 1 1 30%;
                min-width: 90px;
                margin: 3px 0;
            }
            
            .info-label {
                font-size: 0.6rem;
            }
            
            .info-value {
                font-size: 0.8rem;
            }
            
            .answer-form {
                gap: 8px;
                margin-top: 8px;
            }
            
            .answer-input {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .submit-btn {
                padding: 8px 15px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 360px) {
            .title {
                font-size: 1.2rem;
            }
            
            .subtitle {
                font-size: 0.7rem;
            }
            
            .visualizer-container {
                height: 60px;
            }
            
            .bar {
                width: 3px;
            }
            
            .btn {
                width: 36px;
                height: 36px;
                font-size: 12px;
            }
            
            .typing-text {
                min-height: 40px;
                font-size: 0.7rem;
            }
            
            .info-item {
                flex: 1 1 45%;
            }
        }

        /* Дополнительные оптимизации для планшетов */
        @media (min-width: 769px) and (max-width: 1024px) and (orientation: portrait) {
            .frostpunk-container {
                width: 90%;
                max-width: 700px;
            }
            
            .title {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
            }
            
            .visualizer-container {
                height: 150px;
            }
        }    

        /* Анимация печати текста */
        @keyframes typing-cursor {
            0%, 100% { border-color: transparent; }
            50% { border-color: #00b4ff; }
        }
    </style>
</head>
<body>
    <div class="snow-background" id="snowBackground"></div>
    
    <div class="frostpunk-container">
        <div class="city-background"></div>
        <div class="frost-overlay"></div>
        
        <div class="frost-effects" id="frostEffects">
            <!-- Снежинки и пар будут добавлены через JS -->
        </div>
        
        <div class="content">
            <div class="header">
                <h1 class="title">МОРОЗАЛ: ГОЛОС ЛЬДА</h1>
                <div class="subtitle">ГЛАВА 5: ДЕМОНСТРАЦИЯ ФЕНИКСА</div>
            </div>
            
            <div class="player-container">
                <div class="visualizer-container">
                    <div class="visualizer" id="visualizer"></div>
                </div>
                
                <div class="controls">
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-fill" id="progress"></div>
                    </div>
                    
                    <div class="time-info">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    
                    <div class="buttons">
                        <button class="btn" id="prevBtn"><i class="fas fa-step-backward"></i></button>
                        <button class="btn" id="playBtn"><i class="fas fa-play"></i></button>
                        <button class="btn" id="nextBtn"><i class="fas fa-step-forward"></i></button>
                    </div>
                </div>
                
                <div class="info-panel">
                    <div class="info-item">
                        <div class="info-label">ТЕМПЕРАТУРА</div>
                        <div class="info-value" id="tempValue">-42°C</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">МОЩНОСТЬ</div>
                        <div class="info-value" id="powerValue">87%</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">НАПРЯЖЕНИЕ</div>
                        <div class="info-value" id="voltageValue">4.7kV</div>
                    </div>
                </div>
            </div>
            
            <div class="message-box">
                <div class="message-title">ПОСЛАНИЕ ГЕНЕРАТОРА</div>
                <div class="message-content">
                    <div id="typingText" class="typing-text"></div>
                </div>
            </div>
            
            <!-- Новый блок для ввода ответа -->
            <div class="message-box">
                <div class="message-title">ОТВЕТЬТЕ НА ВОПРОС</div>
                <div class="answer-form">
                    <input type="text" id="answerInput" class="answer-input" placeholder="Введите ваш ответ...">
                    <button id="submitBtn" class="submit-btn">ПРОВЕРИТЬ ОТВЕТ</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="audioPlayer">
        <source src="sound5.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Фоновая музыка -->
    <audio id="bgMusic" loop>
        <source src="frost.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Элементы DOM
        const audio = document.getElementById('audioPlayer');
        const bgMusic = document.getElementById('bgMusic'); // Фоновая музыка
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const visualizer = document.getElementById('visualizer');
        const progress = document.getElementById('progress');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const frostEffects = document.getElementById('frostEffects');
        const snowBackground = document.getElementById('snowBackground');
        const tempValue = document.getElementById('tempValue');
        const powerValue = document.getElementById('powerValue');
        const voltageValue = document.getElementById('voltageValue');
        const typingTextEl = document.getElementById('typingText');
        const answerInput = document.getElementById('answerInput');
        const submitBtn = document.getElementById('submitBtn');
        
        // Текст для печати
        const fullText = "Председатель... Совет голосовал. Орхидея — не цветок. Это — сигнал. Сигнал, что жизнь победит. Код активации: это решение сложной формулы, которую пока еще никто не смог решить";
        const correctAnswer = "694"; // Правильный ответ
        let isTypingStarted = false;
        let isAudioPlaying = false;
        let successNotification = null;
        
        // Создаем полосы визуализатора
        for (let i = 0; i < 36; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            visualizer.appendChild(bar);
        }
        const bars = document.querySelectorAll('.bar');
        
        // Массив для сглаживания значений высот столбцов
        const barValues = new Array(bars.length).fill(0);
        
        // Создаем снежинки для фона (интенсивный снегопад)
        function createSnowflake() {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            
            // Разные символы снежинок
            const snowflakeChars = ['❄', '❅', '❆', '＊', '·'];
            const randomChar = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)];
            
            snowflake.innerHTML = randomChar;
            snowflake.style.left = Math.random() * 100 + 'vw';
            
            // Разные размеры
            const size = Math.random() * 20 + 10;
            snowflake.style.fontSize = size + 'px';
            
            // Разная скорость падения
            const duration = Math.random() * 10 + 5;
            snowflake.style.animationDuration = duration + 's';
            
            // Разная прозрачность
            snowflake.style.opacity = Math.random() * 0.7 + 0.3;
            
            // Начальное вращение
            const rotation = Math.random() * 360;
            snowflake.style.transform = `rotate(${rotation}deg)`;
            
            // Разная задержка начала анимации
            snowflake.style.animationDelay = Math.random() * 5 + 's';
            
            // Случайное смещение по горизонтали (хаотичный ветер)
            const wind = (Math.random() - 0.5) * 100; // от -50px до 50px
            snowflake.style.setProperty('--wind', wind + 'px');
            
            snowBackground.appendChild(snowflake);
            
            // Удаление снежинки после завершения анимации
            setTimeout(() => {
                snowflake.remove();
            }, duration * 1000);
        }
        
        // Создаем снежинки для контейнера плеера
        function createPlayerSnowflake() {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            
            // Разные символы снежинок
            const snowflakeChars = ['❄', '❅', '❆', '＊', '·'];
            const randomChar = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)];
            
            snowflake.innerHTML = randomChar;
            snowflake.style.left = Math.random() * 100 + '%';
            
            // Разные размеры
            const size = Math.random() * 15 + 8;
            snowflake.style.fontSize = size + 'px';
            
            // Разная скорость падения
            const duration = Math.random() * 8 + 4;
            snowflake.style.animationDuration = duration + 's';
            
            // Разная прозрачность
            snowflake.style.opacity = Math.random() * 0.6 + 0.2;
            
            // Начальное вращение
            const rotation = Math.random() * 360;
            snowflake.style.transform = `rotate(${rotation}deg)`;
            
            // Разная задержка начала анимации
            snowflake.style.animationDelay = Math.random() * 3 + 's';
            
            // Случайное смещение по горизонтали (хаотичный ветер)
            const wind = (Math.random() - 0.5) * 50; // от -25px до 25px
            snowflake.style.setProperty('--wind', wind + 'px');
            
            frostEffects.appendChild(snowflake);
            
            // Удаление снежинки после завершения анимации
            setTimeout(() => {
                snowflake.remove();
            }, duration * 1000);
        }
        
        // Создаем эффект пара
        function createSteam() {
            const steam = document.createElement('div');
            steam.className = 'steam-effect';
            steam.style.left = Math.random() * 100 + '%';
            steam.style.animationDuration = Math.random() * 4 + 4 + 's';
            steam.style.width = Math.random() * 80 + 50 + 'px';
            steam.style.height = Math.random() * 80 + 50 + 'px';
            frostEffects.appendChild(steam);
            
            setTimeout(() => {
                steam.remove();
            }, 6000);
        }
        
        // Создаем шестеренки
        for (let i = 0; i < 4; i++) {
            const gear = document.createElement('div');
            gear.className = 'gear';
            gear.innerHTML = '⚙️';
            gear.style.top = Math.random() * 100 + '%';
            gear.style.left = Math.random() * 100 + '%';
            gear.style.animationDuration = Math.random() * 20 + 10 + 's';
            gear.style.fontSize = Math.random() * 30 + 20 + 'px';
            frostEffects.appendChild(gear);
        }
        
        // Настройка Web Audio API
        let audioCtx, analyser, source;
        
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaElementSource(audio);
            
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 128; // Уменьшили для более плавной визуализации
            analyser.smoothingTimeConstant = 0.85; // Добавили сглаживание
            
            // Запускаем фоновую музыку
            bgMusic.volume = 0.3; // 30% громкости
            bgMusic.play().catch(e => console.log("Фоновая музыка не может быть воспроизведена:", e));
        }
        
        // Эффект печати текста
        function typeText() {
            if (!audio.duration) return;
            
            const progress = audio.currentTime / audio.duration;
            const charsToShow = Math.floor(progress * fullText.length);
            
            typingTextEl.textContent = fullText.substring(0, charsToShow);
            
            // Добавляем мигающий курсор в конце текста
            if (charsToShow < fullText.length) {
                typingTextEl.style.borderRight = "2px solid #00b4ff";
                typingTextEl.style.animation = "typing-cursor 1s infinite";
            } else {
                typingTextEl.style.borderRight = "none";
                typingTextEl.style.animation = "none";
            }
        }
        
        // Визуализация с улучшенным контролем высоты
        function visualize() {
            if (!analyser) return;
            
            requestAnimationFrame(visualize);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            const barCount = bars.length;
            const step = Math.floor(bufferLength / barCount);
            
            for (let i = 0; i < barCount; i++) {
                // Уменьшили коэффициент с 1.2 до 0.8 и добавили сглаживание
                const rawValue = dataArray[i * step];
                const smoothedValue = barValues[i] * 0.7 + rawValue * 0.3;
                barValues[i] = smoothedValue;
                
                // Ограничиваем высоту, чтобы столбцы не выходили за пределы
                const height = Math.min(100, smoothedValue * 0.8) + '%';
                const hue = 200 + smoothedValue * 0.3;
                
                bars[i].style.height = height;
                bars[i].style.background = `linear-gradient(to top, hsl(${hue}, 100%, 50%), #0077ff)`;
            }
            
            // Обновление прогресс-бара
            progress.style.width = (audio.currentTime / audio.duration) * 100 + '%';
            currentTimeEl.textContent = formatTime(audio.currentTime);
            
            // Обновление панели информации
            const avgValue = dataArray.reduce((a, b) => a + b, 0) / bufferLength;
            tempValue.textContent = `-${Math.round(40 + avgValue * 0.1)}°C`;
            powerValue.textContent = `${Math.min(100, Math.round(avgValue * 0.4))}%`;
            voltageValue.textContent = `${(4 + avgValue * 0.01).toFixed(1)}kV`;
            
            // Обновление печатающегося текста
            if (isAudioPlaying && isTypingStarted) {
                typeText();
            }
        }
        
        // Форматирование времени
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
        
        // Показать уведомление
        function showNotification(message, isSuccess) {
            // Удаляем предыдущее успешное уведомление, если оно есть
            if (successNotification) {
                successNotification.remove();
                successNotification = null;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${isSuccess ? 'success-notification' : 'error-notification'}`;
            
            // Создаем текст уведомления
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            notification.appendChild(messageSpan);
            
            // Для успешных уведомлений добавляем кнопку закрытия
            if (isSuccess) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.addEventListener('click', () => {
                    notification.remove();
                    successNotification = null;
                });
                notification.appendChild(closeBtn);
                
                // Сохраняем ссылку на успешное уведомление
                successNotification = notification;
            }
            
            document.body.appendChild(notification);
            
            // Для сообщений об ошибке удаляем через 3 секунды
            if (!isSuccess) {
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }
        
        // Проверка ответа
        function checkAnswer() {
            const userAnswer = answerInput.value.trim();
            
            if (!userAnswer) {
                showNotification("Введите ваш ответ!", false);
                return;
            }
            
            if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                showNotification("✓ Правильно! Скорее откройте биокапсулу", true);
                // Отключаем поле ввода после правильного ответа
                answerInput.disabled = true;
                submitBtn.disabled = true;
                submitBtn.textContent = "ОТВЕТ ПРИНЯТ";
                submitBtn.style.background = "linear-gradient(to right, #00c853, #009624)";
            } else {
                showNotification("✗ Неверный ответ. Попробуйте еще раз. Биокапсула в беде, она может замерзнуть...", false);
                answerInput.value = ""; // Очищаем поле ввода
                answerInput.focus(); // Возвращаем фокус на поле ввода
            }
        }
        
        // Управление воспроизведением
        playBtn.addEventListener('click', () => {
            if (audio.paused) {
                audio.play();
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isAudioPlaying = true;
                
                if (!audioCtx) initAudio();
                
                // Запускаем печать текста при начале воспроизведения
                if (!isTypingStarted) {
                    isTypingStarted = true;
                    typingTextEl.textContent = '';
                }
                
                visualize();
            } else {
                audio.pause();
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                isAudioPlaying = false;
            }
        });
        
        prevBtn.addEventListener('click', () => {
            audio.currentTime = Math.max(0, audio.currentTime - 10);
            typeText(); // Обновляем текст при перемотке
        });
        
        nextBtn.addEventListener('click', () => {
            audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
            typeText(); // Обновляем текст при перемотке
        });
        
        // Перемотка по клику на прогресс-бар
        progressContainer.addEventListener('click', (e) => {
            const pos = e.offsetX / progressContainer.offsetWidth;
            audio.currentTime = pos * audio.duration;
            typeText(); // Обновляем текст при перемотке
        });
        
        // Обновление общего времени при загрузке метаданных
        audio.addEventListener('loadedmetadata', () => {
            totalTimeEl.textContent = formatTime(audio.duration);
        });
        
        // Сброс текста при завершении воспроизведения
        audio.addEventListener('ended', () => {
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            isAudioPlaying = false;
            // Убедимся, что текст полностью напечатан
            typingTextEl.textContent = fullText;
            typingTextEl.style.borderRight = "none";
            typingTextEl.style.animation = "none";
        });
        
        // Обработчик отправки ответа
        submitBtn.addEventListener('click', checkAnswer);
        
        // Обработчик нажатия Enter в поле ввода
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        // Запуск эффектов снега
        setInterval(createSnowflake, 100); // Увеличили интенсивность снегопада
        setInterval(createPlayerSnowflake, 150); // Снег внутри плеера
        setInterval(createSteam, 1800);
        
        // Инициализация при загрузке
        window.addEventListener('load', () => {
            totalTimeEl.textContent = formatTime(audio.duration);
            // Инициализируем аудио при первом взаимодействии
            document.body.addEventListener('click', function init() {
                if (!audioCtx) {
                    initAudio();
                }
                document.body.removeEventListener('click', init);
            });
            
            // Создаем начальные снежинки
            for (let i = 0; i < 50; i++) {
                setTimeout(() => createSnowflake(), Math.random() * 3000);
                setTimeout(() => createPlayerSnowflake(), Math.random() * 3000);
            }
        });
    </script>
</body>
</html>